<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Loki | XRs_</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/vuepressBlog/logo.jpg">
    <meta name="description" content="看脚下一片黑暗 望头顶星光璀璨">
    
    <link rel="preload" href="/vuepressBlog/assets/css/0.styles.113a432f.css" as="style"><link rel="preload" href="/vuepressBlog/assets/js/app.db668e09.js" as="script"><link rel="preload" href="/vuepressBlog/assets/js/2.3a32f68b.js" as="script"><link rel="preload" href="/vuepressBlog/assets/js/24.edc5c78a.js" as="script"><link rel="prefetch" href="/vuepressBlog/assets/js/10.b199c600.js"><link rel="prefetch" href="/vuepressBlog/assets/js/11.51df3337.js"><link rel="prefetch" href="/vuepressBlog/assets/js/12.7fd82735.js"><link rel="prefetch" href="/vuepressBlog/assets/js/13.65419b09.js"><link rel="prefetch" href="/vuepressBlog/assets/js/14.ec1cc95e.js"><link rel="prefetch" href="/vuepressBlog/assets/js/15.9b422881.js"><link rel="prefetch" href="/vuepressBlog/assets/js/16.ed9ba024.js"><link rel="prefetch" href="/vuepressBlog/assets/js/17.932b2a7e.js"><link rel="prefetch" href="/vuepressBlog/assets/js/18.5e1b25f4.js"><link rel="prefetch" href="/vuepressBlog/assets/js/19.a875aefb.js"><link rel="prefetch" href="/vuepressBlog/assets/js/20.f9d56d39.js"><link rel="prefetch" href="/vuepressBlog/assets/js/21.b6c1b6d4.js"><link rel="prefetch" href="/vuepressBlog/assets/js/22.a25b81c7.js"><link rel="prefetch" href="/vuepressBlog/assets/js/23.5e136c4d.js"><link rel="prefetch" href="/vuepressBlog/assets/js/25.8bc67b54.js"><link rel="prefetch" href="/vuepressBlog/assets/js/26.5864d123.js"><link rel="prefetch" href="/vuepressBlog/assets/js/3.5929aabd.js"><link rel="prefetch" href="/vuepressBlog/assets/js/4.986321b7.js"><link rel="prefetch" href="/vuepressBlog/assets/js/5.faf0dd39.js"><link rel="prefetch" href="/vuepressBlog/assets/js/6.6d8522e0.js"><link rel="prefetch" href="/vuepressBlog/assets/js/7.4957f0ac.js"><link rel="prefetch" href="/vuepressBlog/assets/js/8.b2fc41fa.js"><link rel="prefetch" href="/vuepressBlog/assets/js/9.cc0de62c.js">
    <link rel="stylesheet" href="/vuepressBlog/assets/css/0.styles.113a432f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepressBlog/" class="home-link router-link-active"><img src="/vuepressBlog/logo.jpg" alt="XRs_" class="logo"> <span class="site-name can-hide">XRs_</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepressBlog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/java/databases/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/vuepressBlog/java/logs/" class="nav-link router-link-active">
  日志框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/more/changeLogs.html" class="nav-link">
  迭代记录
</a></li></ul></div></div><div class="nav-item"><a href="/vuepressBlog/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="爱好" class="dropdown-title"><span class="title">爱好</span> <span class="arrow down"></span></button> <button type="button" aria-label="爱好" class="mobile-dropdown-title"><span class="title">爱好</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/about/hobbies/booklist/" class="nav-link">
  读书
</a></li><li class="dropdown-item"><!----> <a href="/vuepressBlog/about/hobbies/films/" class="nav-link">
  电影
</a></li></ul></div></div> <a href="https://github.com/sunhl-y/vuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepressBlog/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/java/databases/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/vuepressBlog/java/logs/" class="nav-link router-link-active">
  日志框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><span class="title">更多</span> <span class="arrow down"></span></button> <button type="button" aria-label="更多" class="mobile-dropdown-title"><span class="title">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/more/changeLogs.html" class="nav-link">
  迭代记录
</a></li></ul></div></div><div class="nav-item"><a href="/vuepressBlog/about/" class="nav-link">
  关于
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="爱好" class="dropdown-title"><span class="title">爱好</span> <span class="arrow down"></span></button> <button type="button" aria-label="爱好" class="mobile-dropdown-title"><span class="title">爱好</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepressBlog/about/hobbies/booklist/" class="nav-link">
  读书
</a></li><li class="dropdown-item"><!----> <a href="/vuepressBlog/about/hobbies/films/" class="nav-link">
  电影
</a></li></ul></div></div> <a href="https://github.com/sunhl-y/vuepressBlog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>日志框架</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepressBlog/java/logs/Loki.html" aria-current="page" class="active sidebar-link">Loki</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#简单应用场景说明" class="sidebar-link">简单应用场景说明</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#loki-http-api" class="sidebar-link">Loki HTTP API</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#查询日志流" class="sidebar-link">查询日志流</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#查询标签" class="sidebar-link">查询标签</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#匹配特定标签集列表" class="sidebar-link">匹配特定标签集列表</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#删除日志流" class="sidebar-link">删除日志流</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#推送日志" class="sidebar-link">推送日志</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#其他" class="sidebar-link">其他</a></li></ul></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#logql" class="sidebar-link">LogQL</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#loki配置-limits-config" class="sidebar-link">Loki配置 - Limits_Config</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#java简单应用" class="sidebar-link">Java简单应用</a></li><li class="sidebar-sub-header"><a href="/vuepressBlog/java/logs/Loki.html#可视化界面" class="sidebar-link">可视化界面</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="loki"><a href="#loki" class="header-anchor">#</a> Loki</h1> <p><a href="https://grafana.com/docs/loki/next/fundamentals/overview/" target="_blank" rel="noopener noreferrer">Loki官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/linqianye/loki-doc/tree/main/docs" target="_blank" rel="noopener noreferrer">Loki中文文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/grafana/loki" target="_blank" rel="noopener noreferrer">Loki开源地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="简单应用场景说明"><a href="#简单应用场景说明" class="header-anchor">#</a> 简单应用场景说明</h2> <p>需求：下载近七天日志</p> <p>实现：每隔一小时定期上传日志，平台监测并将上传的日志存储到loki，点击下载时直接根据时间段从loki中取近七天日志</p> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>Loki：轻量级日志系统</p> <p><strong>特点：</strong></p> <ul><li>Go语言实现</li> <li>日志采集</li> <li>日志压缩存储</li> <li>标签分组</li> <li>日志可视化</li> <li>可扩展性（每个组件都可以单独运行）</li> <li>多租户（通过Promtail分配tenantID，租户ID从请求的HTTP Header提取）</li> <li>LogQL（有小小的学习成本）</li> <li>中小数据量比较适合</li></ul> <p><strong>对比ELK:</strong></p> <ul><li>轻量</li> <li>存储成本低</li> <li>检索能力较差</li> <li>功能单一，数据处理及清洗没有ELK强大</li></ul> <p><strong>场景说明：</strong></p> <p>适用：</p> <ul><li>查看日志解决故障</li> <li>少量小范围的日志查看，如5分钟内的日志，5分钟前的500条日志</li> <li>分布式系统日志查看</li> <li>基于k8s日志收集</li></ul> <p>不适用：</p> <ul><li>大型数据聚合和统一分析</li> <li>大范围查询日志</li> <li>依赖内存，可能OOM</li></ul> <p><strong>原理：</strong></p> <p>为每个日志流设置一组标签，根据标签索引</p> <ul><li>Promtail，基于prometheus，采集客户端日志加上标签发送给Loki（代理获取日志将日志转换成流并通过HTTP API将流推送给Loki）</li> <li>Loki，日志存储解析，并提供查询API给下游展示</li> <li>Grafana，从Loki中获取日志信息，可视化展示</li></ul> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1648631882869-fd010ff6-0514-42e5-88a1-482a5930f64c.png" alt="img"></p> <p>日志数据本身也会被压缩</p> <p>Loki能够以微服务模式运行，也就是把自身的各个模块分解出单个进程，比如横向扩展多个查询器模块可提高查询性能</p> <p><strong>组件：</strong></p> <p>promtail会将日志推送至Loki提供的基于Http的API，Loki将收到的日志按照标签进行分发存储，并在需要时使用LogQL进行查询</p> <p>Loki实现由众多的组件组成，每个组件都会拉起一个gRPC服务实现内部互通，同时也对外暴露一个HTTP/1的服务来提供外部服务以应答API请求</p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1648629990574-7de093e5-90a2-4ac8-a4b3-3cb6ce4100b8.png" alt="img"></p> <ul><li><p>Distributor，分发从客户端上报的日志，校验完后分发给ingester处理，一致性哈希</p></li> <li><p>Ingester，将日志转储到后端存储，负责构建和刷新chunck（内存缓存刷盘）</p></li> <li><p>Query frontend（optional），加速查询</p></li> <li><p>Querier，查询</p></li> <li><p>Chunk Store，后端存储框架，索引存储/日志数据存储</p></li> <li><ul><li>索引存储，Amazon DynamoDB, Google Bigtable, Apsache Cassandra</li> <li>日志存储，Amazon DynamoDB, Google Bigtable, Apsache Cassandra, Amazon S3, Google Cloud Store</li></ul></li></ul> <p><strong>安装部署</strong></p> <p>https://grafana.com/docs/loki/next/installation/</p> <ul><li>适用Tanka安装</li> <li>Helm+k8s（适用Loki微服务模式）</li> <li>docker-compose安装</li> <li>本地安装运行</li> <li>从源代码安装</li></ul> <p><strong>一般流程</strong></p> <ul><li>下载安装Loki和Promtail</li> <li>下载两个的配置文件</li> <li>启动Loki</li> <li>更新Promtail的配置文件</li> <li>启动Promtail</li></ul> <h2 id="loki-http-api"><a href="#loki-http-api" class="header-anchor">#</a> Loki HTTP API</h2> <p><strong>如果需要直接向Loki推送日志，可以直接调用Loki HTTP API</strong></p> <p><strong>列出了一些常用的API如下</strong></p> <p>返回结果类型：</p> <ul><li>矩阵：一个数值表，其中每一行代表一个不同的标签集，列是该行在被查询时间内的每个样本值。矩阵类型只有在运行计算一些数值的查询时才会返回。</li> <li>即时向量：在类型中仅表示为 ，即时向量表示给定标签集的计算的最新值。即时向量只在针对单一时间点进行查询时返回。</li> <li>流：流是一组给定标签集在查询时间范围内的所有值（日志）。流是唯一会导致日志行被返回的类型。</li></ul> <h3 id="查询日志流"><a href="#查询日志流" class="header-anchor">#</a> 查询日志流</h3> <h4 id="get-loki-api-v1-query-允许对单一时间点执行查询"><a href="#get-loki-api-v1-query-允许对单一时间点执行查询" class="header-anchor">#</a> <code>GET /loki/api/v1/query</code><strong>（允许对单一时间点执行查询）</strong></h4> <p>参数：</p> <p>query：要执行的LogQL查询</p> <p>limit: 要返回的最大条目数</p> <p>time: 查询的评估时间作为一个纳秒的 Unix 纪元。默认为现在。</p> <p>direction：确定日志的排序顺序。支持的值为forward或backward。默认为backward</p> <p>示例：</p> <div class="language-json extra-class"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//192.168.15.139:30100/loki/api/v1/query</span>
?direction=BACKWARD
&amp;limit=<span class="token number">1000</span>
&amp;query=sum(rate(<span class="token punctuation">{</span>job=<span class="token string">&quot;anychatlog&quot;</span><span class="token punctuation">}</span><span class="token punctuation">[</span>2d<span class="token punctuation">]</span>))
</code></pre></div><h4 id="get-loki-api-v1-query-range-查询某个时间段日志"><a href="#get-loki-api-v1-query-range-查询某个时间段日志" class="header-anchor">#</a> <code>GET /loki/api/v1/query_range</code><strong>（查询某个时间段日志）</strong></h4> <p>参数：</p> <p>query：要执行的LogQL查询</p> <p>limit: 要返回的最大条目数</p> <p>start: 查询的开始时间，以纳秒 Unix 纪元表示。默认为一小时前。</p> <p>end: 查询的结束时间，以纳秒 Unix 纪元表示。默认为现在。</p> <p>step: 以duration格式或浮点秒数查询分辨率步长。duration指形式为 的 Prometheus 持续时间字符串[0-9]+[smhdwy]。例如，5m 表示持续时间为 5 分钟。默认为基于start和的动态值end。仅适用于产生矩阵响应的查询类型。</p> <p>interval：这个参数是实验性的；请参阅step vs interval下的说明。只返回（或大于）指定间隔的条目，可以是duration格式或浮点数。仅适用于产生流响应的查询。</p> <p>direction：确定日志的排序顺序。支持的值为forward或backward。默认为backward.</p> <p>示例：</p> <div class="language-json extra-class"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//192.168.15.139:30100/loki/api/v1/query_range</span>
?direction=BACKWARD
&amp;limit=<span class="token number">1000</span>
&amp;query=<span class="token punctuation">{</span>job=<span class="token string">&quot;anychatlog&quot;</span><span class="token punctuation">}</span> 
&amp;start=<span class="token number">1641280408415000000</span>
&amp;end=<span class="token number">1641453208415000000</span>
&amp;step=<span class="token number">120</span>
</code></pre></div><h3 id="查询标签"><a href="#查询标签" class="header-anchor">#</a> 查询标签</h3> <h4 id="get-loki-api-v1-labels-查询标签列表"><a href="#get-loki-api-v1-labels-查询标签列表" class="header-anchor">#</a> <code>GET /loki/api/v1/labels</code><strong>（查询标签列表）</strong></h4> <p>参数：</p> <p>start：开始时间，默认为6小时前</p> <p>end：查询结束时间，默认为现在</p> <p>示例：</p> <div class="language-json extra-class"><pre class="language-json"><code> http<span class="token operator">:</span><span class="token comment">//192.168.15.139:30100/loki/api/v1/labels</span>
</code></pre></div><h4 id="get-loki-api-v1-label-name-values-查询标签值"><a href="#get-loki-api-v1-label-name-values-查询标签值" class="header-anchor">#</a> <code>GET /loki/api/v1/label/&lt;name&gt;/values</code>(查询标签值)</h4> <p>参数：</p> <p>name：GET /loki/api/v1/label中的标签</p> <p>start：开始时间，默认为6小时前</p> <p>end：查询结束时间，默认为现在</p> <p>示例：</p> <div class="language-json extra-class"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//192.168.15.139:30100/loki/api/v1/label/job/values</span>
</code></pre></div><h3 id="匹配特定标签集列表"><a href="#匹配特定标签集列表" class="header-anchor">#</a> 匹配特定标签集列表</h3> <div class="language-json extra-class"><pre class="language-json"><code>GET /loki/api/v1/series
POST /loki/api/v1/series
</code></pre></div><p>参数：</p> <p>match[]=&lt;series_selector&gt;：选择要返回的日志流的标签。match[]必须至少提供一个参数。</p> <p>start=: 开始时间戳。</p> <p>end=: 结束时间戳。</p> <p>示例：</p> <div class="language-json extra-class"><pre class="language-json"><code>http<span class="token operator">:</span><span class="token comment">//192.168.15.139:30100/loki/api/v1/series</span>
?start=<span class="token number">1640922291907000000</span>
&amp;end=<span class="token number">1641527091908000000</span>
&amp;match<span class="token punctuation">[</span><span class="token punctuation">]</span>=<span class="token punctuation">{</span>host=<span class="token string">&quot;192.168.11.123&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="删除日志流"><a href="#删除日志流" class="header-anchor">#</a> 删除日志流</h3> <p>需要2.3.0以上版本的Loki，并按官方文档进行配置</p> <h4 id="删除日志流-2"><a href="#删除日志流-2" class="header-anchor">#</a> 删除日志流</h4> <div class="language-java extra-class"><pre class="language-java"><code>POST loki_addr<span class="token operator">/</span>loki<span class="token operator">/</span>api<span class="token operator">/</span>admin<span class="token operator">/</span>delete<span class="token operator">?</span>match<span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>参数：</p> <p>match[]:标签匹配器，用于标识要从中删除的流,必须至少提供一个参数</p> <p>&lt;series_selector&gt;:查询参数</p> <p>start:开始的时间戳</p> <p>end:结束的时间戳</p> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">192.168</span><span class="token number">.15</span><span class="token number">.139</span><span class="token operator">:</span><span class="token number">30100</span><span class="token operator">/</span>loki<span class="token operator">/</span>api<span class="token operator">/</span>admin<span class="token operator">/</span>delete<span class="token operator">?</span>match<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span>job<span class="token operator">=</span><span class="token string">&quot;anychatlog&quot;</span><span class="token punctuation">}</span>
</code></pre></div><h3 id="推送日志"><a href="#推送日志" class="header-anchor">#</a> 推送日志</h3> <h4 id="post-loki-api-v1-push"><a href="#post-loki-api-v1-push" class="header-anchor">#</a> POST /loki/api/v1/push</h4> <p>向loki发送日志条目的endpoint，默认POST主体是 snappy-compressed protobuf 消息</p> <p>可以传 json 格式，设置 content-type为application/json</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;streams&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;stream&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;label&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span> <span class="token comment">// 标签，可以使用多个标签标识日志流</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">&quot;values&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">[</span> <span class="token string">&quot;&lt;unix epoch in nanoseconds&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;log line&gt;&quot;</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 格式固定，时间戳+日志行</span>
        <span class="token punctuation">[</span> <span class="token string">&quot;&lt;unix epoch in nanoseconds&gt;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&lt;log line&gt;&quot;</span> <span class="token punctuation">]</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="其他"><a href="#其他" class="header-anchor">#</a> 其他</h3> <h4 id="get-loki-api-v1-tail"><a href="#get-loki-api-v1-tail" class="header-anchor">#</a> GET /loki/api/v1/tail</h4> <p>websocket endpoint，根据查询来流转日志信息</p> <h4 id="get-ready"><a href="#get-ready" class="header-anchor">#</a> GET /ready</h4> <p>当Loki采集器准备好接受流量时，/ready会返回HTTP 200。如果在Kubernetes上运行Loki，可以作为准备就绪的探测器。</p> <h4 id="post-flush"><a href="#post-flush" class="header-anchor">#</a> POST /flush</h4> <p>触发刷新由ingesters持有的所有内存块到后备存储。主要用于本地测试。</p> <h2 id="logql"><a href="#logql" class="header-anchor">#</a> LogQL</h2> <p>如果需要进行更复杂的查询，可以自行编写LogQL</p> <p><a href="https://grafana.com/docs/loki/latest/logql/" target="_blank" rel="noopener noreferrer">LogQL官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://cloud.tencent.com/developer/article/1839410" target="_blank" rel="noopener noreferrer">Loki查询语言LogQL使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（相对较全面）</p> <p><a href="https://www.feiyiblog.com/2021/10/11/Loki%E7%9A%84LogQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E6%B3%95/" target="_blank" rel="noopener noreferrer">Loki的LogQL查询语法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（标签过滤+行过滤）</p> <ul><li>log query：返回日志行的内容</li> <li>metric query：扩展了日志查询，根据查询结果来计算数值</li></ul> <h2 id="loki配置-limits-config"><a href="#loki配置-limits-config" class="header-anchor">#</a> Loki配置 - Limits_Config</h2> <p>https://www.jianshu.com/p/2674c27d17c8</p> <h2 id="java简单应用"><a href="#java简单应用" class="header-anchor">#</a> Java简单应用</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LokiService</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WebClient</span> webClient<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SYSLOG_QUERY_URL <span class="token operator">=</span>
        <span class="token string">&quot;loki/api/v1/query_range?query={query}&amp;start={start}&amp;end={end}&amp;limit={limit}&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> SYSLOG_PUSH_URL <span class="token operator">=</span> <span class="token string">&quot;loki/api/v1/push&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// LokiProperties中存储loki地址</span>
    <span class="token keyword">public</span> <span class="token class-name">LokiService</span><span class="token punctuation">(</span><span class="token class-name">WebClient<span class="token punctuation">.</span>Builder</span> builder<span class="token punctuation">,</span> <span class="token class-name">LokiProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>webClient <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 查询一定时间范围内的数据</span>
    <span class="token keyword">public</span> <span class="token class-name">DeviceSyslogsQueryRes</span> <span class="token function">queryLogs</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        
        <span class="token keyword">return</span> webClient
            <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span>SYSLOG_QUERY_URL<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParameterizedTypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DeviceSyslogsQueryRes</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 向loki推送数据</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushLogs</span><span class="token punctuation">(</span><span class="token class-name">Document</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        webClient
            <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">uri</span><span class="token punctuation">(</span>SYSLOG_PUSH_URL<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bodyValue</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">retrieve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">bodyToMono</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ParameterizedTypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token operator">::</span><span class="token function">getResult</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="可视化界面"><a href="#可视化界面" class="header-anchor">#</a> 可视化界面</h2> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239046511-2dde2674-3a25-462a-aac2-d12ab701b344.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239065864-3f56e8a3-c48a-450b-b33b-9712d4e841ce.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239073520-8427b140-cf74-4bca-9a12-8a168d06e2b2.png" alt="img"><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239126328-623c4ccd-8045-44f0-8742-c50c7a874afe.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239136913-cffcdbbf-d398-43a1-ba68-08646fe9c27c.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239142022-538c4cfb-605a-4c8d-98f6-874a8f18a8fe.png" alt="img"></p> <p>官网:https://grafana.com/grafana/dashboards
<img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239161607-b6c5a56c-860a-4aa3-bc18-0b8a27507007.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239161725-2b2a3569-f017-4afe-b41b-dfeb56a9e141.png" alt="img"></p> <p>简单粗暴，直接复制node_exporter 的ID导入仪表盘，当然也可以通过其他两种方式导入
<img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239161358-5dfe8b30-e068-42d3-af28-d4095fa2b17e.png" alt="img"></p> <p><img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239161430-31c86aff-3226-4140-a5d5-ef69420f3c15.png" alt="img"> <img src="https://typora-1304207839.cos.ap-chengdu.myqcloud.com/typora/1649239161653-def61622-d168-43ea-a5b3-f9eb574f1594.png" alt="img"></p> <hr> <p>参考：</p> <p><a href="https://zhuanlan.zhihu.com/p/163809795" target="_blank" rel="noopener noreferrer">轻量级日志系统Loki原理简介和使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（环境搭建）</p> <p><a href="https://segmentfault.com/a/1190000040371914" target="_blank" rel="noopener noreferrer">再见笨重的ELK！这套轻量级日志收集方案要火<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（docker-compose安装）</p> <p><a href="https://cloud.tencent.com/developer/article/1668946" target="_blank" rel="noopener noreferrer">Loki数据过期自动删除策略设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7008424451704356872#heading-3" target="_blank" rel="noopener noreferrer">LPG+SpringBoot收集日志<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://felord.cn/loki.html#%E7%AE%80%E5%8D%95%E4%B8%8A%E6%89%8B" target="_blank" rel="noopener noreferrer">SpringBoot2实战：轻量级日志loki集成<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://jishuin.proginn.com/p/763bfbd5a9aa" target="_blank" rel="noopener noreferrer">Loki源码分析之日志写入<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/vuepressBlog/assets/js/app.db668e09.js" defer></script><script src="/vuepressBlog/assets/js/2.3a32f68b.js" defer></script><script src="/vuepressBlog/assets/js/24.edc5c78a.js" defer></script>
  </body>
</html>
